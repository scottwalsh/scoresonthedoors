<!DOCTYPE html> 
<html> 
	<head> 
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" /> 
		<style type="text/css"> 
		html {
			height: 100%
		}
		body {
			height: 100%;
			margin: 0px;
			padding: 0px;
			font-family: Helvetica, Helvetica Neue, Arial, sans-serif;
			color: black;
		}
		a:link, a:visited, a:active {
			text-decoration: none;
			color: yellowgreen
		}
		a:hover {
			text-decoration: underline;
			color: lightgray;
		}
		#map {
			height: 100%;
			float: left;
		}
		#overlay {
		  	position: absolute;
		  	right: 20px;
		  	top: 40px;
		  	color: white; 
		  	border: 0px;
			padding: 20px 40px;
			text-align: center;
			width: 15%;
			-webkit-border-radius: 8px;
			-moz-border-radius: 8px;
			border-radius: 8px;
			background: #000000;
			background-color: rgba(0,0,0,0.75);
		}
		</style>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script> 
		<script type="text/javascript"> 
		//<![CDATA[
		
		var map;
		var markersArray = [];
	 
		function load() {
		  map = new google.maps.Map(document.getElementById("map"), {
		    center: new google.maps.LatLng(53.742676,-0.337574), // St Stephen's (the center of the universe)
		    zoom: 11,
		    mapTypeId: 'roadmap'
		  });
		  var infoWindow = new google.maps.InfoWindow;
	 
		  // Change this depending on the name of your PHP file
		  downloadUrl("phpsqlajax_genxml.php", function(data) {
		    var xml = data.responseXML;
		    var markers = xml.documentElement.getElementsByTagName("marker");
		    for (var i = 0; i < markers.length; i++) {
		      var name = markers[i].getAttribute("name");
		      var address = markers[i].getAttribute("address");
		      var postcode = markers[i].getAttribute("postcode");        
		      var point = new google.maps.LatLng(
		          parseFloat(markers[i].getAttribute("lat")),
		          parseFloat(markers[i].getAttribute("lng")));
		      var accuracy = markers[i].getAttribute("accuracy");
		      var inspection = markers[i].getAttribute("inspection");
		      var score = markers[i].getAttribute("score");
		      var classification = markers[i].getAttribute("classification");
		      var telephone = markers[i].getAttribute("telephone");
		      var type = markers[i].getAttribute("type");
		      var html = "<b>" + name + "<\/b> <br>" + address + "<br>" + score + "<br>" + classification;
		      var iconImage = setIconImage(score);
		      var marker = new google.maps.Marker({
		        map: map,
		        position: point,
		        icon: iconImage,
		        title: classification + " - " + name,
		        shadow: 'http://labs.google.com/ridefinder/images/mm_20_shadow.png'
		      });
		      markersArray.push(marker);
		      bindInfoWindow(marker, map, infoWindow, html);
		    }
		  });
		}
	 
		function bindInfoWindow(marker, map, infoWindow, html) {
		  google.maps.event.addListener(marker, 'click', function() {
		    infoWindow.setContent(html);
		    infoWindow.open(map, marker);
		  });
		}
	 
		function downloadUrl(url, callback) {
		  var request = window.ActiveXObject ?
		      new ActiveXObject('Microsoft.XMLHTTP') :
		      new XMLHttpRequest;
	 
		  request.onreadystatechange = function() {
		    if (request.readyState == 4) {
		      request.onreadystatechange = doNothing;
		      callback(request, request.status);
		    }
		  };
	 
		  request.open('GET', url, true);
		  request.send(null);
		}
	 
		function doNothing() {}
		
		function setIconImage(score)
		{
		    if (score < 60) {
		      return 'http://labs.google.com/ridefinder/images/mm_20_red.png';
		    }
		    if (score < 75) {
		      return 'http://labs.google.com/ridefinder/images/mm_20_orange.png';
		    }
		    if (score < 90) {
		      return 'http://labs.google.com/ridefinder/images/mm_20_yellow.png';
		    }
		    if (score <= 100) {
		      return 'http://labs.google.com/ridefinder/images/mm_20_green.png';
		    }
			return 'http://labs.google.com/ridefinder/images/mm_20_gray.png';
		}
		
		function boxclick(box,category) {
		    if (box.checked) {
		      show(category);
		    } else {
		      hide(category);
		    }
      	}
      	
      	//PROBLEM ACCESSING markersArray[i].classification
      	
      	// A little bit hacky: identify the classification of a marker by checking the first character of the title
      
	   function show(category) {
	   		if (markersArray) {
				for (i in markersArray) {
				
				  if (markersArray[i].title.charAt(0) == category.charAt(0)) {
				    markersArray[i].setMap(map);
				  }
				}
		    }
		}
		
		function hide(category) {
			if (markersArray) {
				for (i in markersArray) {
				  if (markersArray[i].title.charAt(0) == category.charAt(0)) {
				    markersArray[i].setMap(null);
				  }
				}
			}
		}
	 
		//]]>
	 
		</script> 
	</head> 
	<body onload="load()"> 
		<div id="map" style="width:100%; height:100%"></div> 
		<div id="overlay">
			<h1>Scores on the Doors for Kingston upon Hull. Bon appetit.</h1>
			<form>
				Excellent<input type="checkbox" class="classification" onclick="boxclick(this,'A')" checked="checked" />
				&nbsp;
				Good<input type="checkbox" class="classification" onclick="boxclick(this,'B')" checked="checked" />
				&nbsp;
				Acceptable<input type="checkbox" class="classification" onclick="boxclick(this,'C')" checked="checked" />
				&nbsp;
				Poor<input type="checkbox" class="classification" onclick="boxclick(this,'D')" checked="checked" />
				&nbsp;
				Very Poor<input type="checkbox" class="classification" onclick="boxclick(this,'E')" checked="checked" />
			</form>
			<p>
				<a href="http://www.hullcc.gov.uk/portal/page?_dad=portal&_pageid=221,52665&_schema=PORTAL">Data made available by Hull City Council.</a>
			</p>
		</div> 
	</body> 
</html>
